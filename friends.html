<!-- friends.html -->
<h3>Friend Requests</h3>
<div id="requests"></div>

<script type="module">
  import { auth, db } from './firebase.js';
  import {
    doc, getDoc, updateDoc, arrayRemove, arrayUnion
  } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const userDoc = await getDoc(doc(db, "users", user.uid));
    const data = userDoc.data();
    const requests = data.friendRequests;

    let html = '';

    for (let uid of requests) {
      const friendDoc = await getDoc(doc(db, "users", uid));
      const friend = friendDoc.data();

      html += `
        <div>
          <b>${friend.name}</b>
          <button onclick="acceptRequest('${uid}')">Accept</button>
        </div>
      `;
    }

    document.getElementById('requests').innerHTML = html;

    window.acceptRequest = async (uid) => {
      await updateDoc(doc(db, "users", user.uid), {
        friends: arrayUnion(uid),
        friendRequests: arrayRemove(uid)
      });
      await updateDoc(doc(db, "users", uid), {
        friends: arrayUnion(user.uid),
        sentRequests: arrayRemove(user.uid)
      });
      alert("Friend added!");
      location.reload();
    };
  });
</script>
